---
# HashiCorp Vault: Kubernetes Agent Injector Setup
# Reference: https://developer.hashicorp.com/vault/docs/platform/k8s/injector
# Vault 1.18+, vault-k8s 1.4+

# === 1. Install Vault via Helm ===
# helm repo add hashicorp https://helm.releases.hashicorp.com
# helm install vault hashicorp/vault -n vault --create-namespace -f vault-values.yaml

# vault-values.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-helm-values-reference
  namespace: vault
  annotations:
    description: "Reference Helm values â€” use with helm install vault hashicorp/vault -f vault-values.yaml"
data:
  values.yaml: |
    global:
      enabled: true
      tlsDisable: false

    server:
      replicas: 3
      ha:
        enabled: true
        raft:
          enabled: true
          setNodeId: true
          config: |
            ui = true
            cluster_name = "production-vault"

            listener "tcp" {
              tls_disable = 0
              address     = "[::]:8200"
              tls_cert_file = "/vault/userconfig/tls/vault.crt"
              tls_key_file  = "/vault/userconfig/tls/vault.key"
              tls_min_version = "tls13"
            }

            storage "raft" {
              path    = "/vault/data"
              node_id = "POD_NAME"

              retry_join {
                leader_api_addr = "https://vault-0.vault-internal:8200"
                leader_ca_cert_file = "/vault/userconfig/tls/ca.crt"
              }
              retry_join {
                leader_api_addr = "https://vault-1.vault-internal:8200"
                leader_ca_cert_file = "/vault/userconfig/tls/ca.crt"
              }
              retry_join {
                leader_api_addr = "https://vault-2.vault-internal:8200"
                leader_ca_cert_file = "/vault/userconfig/tls/ca.crt"
              }
            }

            seal "awskms" {
              region     = "us-east-1"
              kms_key_id = "mrk-xxxxxxxxxxxxxx"
            }

            service_registration "kubernetes" {}

            telemetry {
              prometheus_retention_time = "12h"
              disable_hostname = true
            }

      extraEnvironmentVars:
        VAULT_CACERT: /vault/userconfig/tls/ca.crt
        VAULT_TLSCERT: /vault/userconfig/tls/vault.crt
        VAULT_TLSKEY: /vault/userconfig/tls/vault.key

      resources:
        requests:
          memory: 256Mi
          cpu: 250m
        limits:
          memory: 1Gi
          cpu: 2000m

      auditStorage:
        enabled: true
        size: 10Gi

    injector:
      enabled: true
      replicas: 2
      resources:
        requests:
          memory: 64Mi
          cpu: 50m
        limits:
          memory: 256Mi
          cpu: 250m
      failurePolicy: Fail          # Reject pod if injector unavailable
      webhookAnnotations:
        admissionregistration.kubernetes.io/inject: "true"

    ui:
      enabled: true
      serviceType: ClusterIP

---
# === 2. Vault Kubernetes Auth Configuration ===
# Run these commands after Vault is initialized:
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-setup-script
  namespace: vault
data:
  setup.sh: |
    #!/bin/bash
    # 1. Initialize Vault (first time only)
    vault operator init -key-shares=5 -key-threshold=3 \
      -format=json > /tmp/vault-init.json

    # 2. Enable K8s auth
    vault auth enable kubernetes

    # 3. Configure K8s auth
    vault write auth/kubernetes/config \
      kubernetes_host="https://kubernetes.default.svc" \
      kubernetes_ca_cert="$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)" \
      token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
      issuer="https://kubernetes.default.svc.cluster.local"

    # 4. Enable KV v2 secrets engine
    vault secrets enable -path=secret kv-v2

    # 5. Enable database secrets engine
    vault secrets enable database

    # 6. Enable audit logging
    vault audit enable file file_path=/vault/audit/audit.log log_raw=false

    # 7. Create example policy
    vault policy write payment-service - << 'EOF'
    path "secret/data/payments/+/database" {
      capabilities = ["read"]
    }
    path "secret/data/payments/+/config" {
      capabilities = ["read"]
    }
    path "database/creds/payment-db-role" {
      capabilities = ["read"]
    }
    path "sys/leases/renew" {
      capabilities = ["create"]
    }
    path "auth/token/create" {
      capabilities = ["create", "update"]
    }
    EOF

    # 8. Create K8s auth role
    vault write auth/kubernetes/role/payment-service \
      bound_service_account_names=payment-service \
      bound_service_account_namespaces=payments \
      policies=payment-service \
      ttl=1h \
      max_ttl=4h

---
# === 3. Deployment with Vault Agent Injector Annotations ===
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: payments
spec:
  replicas: 2
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
      annotations:
        # Core: enable injection and specify role
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "payment-service"
        vault.hashicorp.com/tls-secret: "vault-tls"
        vault.hashicorp.com/ca-cert: "/vault/tls/ca.crt"

        # Inject database credentials as file
        vault.hashicorp.com/agent-inject-secret-db.env: "secret/data/payments/prod/database"
        vault.hashicorp.com/agent-inject-template-db.env: |
          {{ with secret "secret/data/payments/prod/database" -}}
          export DB_HOST="{{ .Data.data.host }}"
          export DB_PORT="{{ .Data.data.port }}"
          export DB_NAME="{{ .Data.data.name }}"
          export DB_USER="{{ .Data.data.username }}"
          export DB_PASS="{{ .Data.data.password }}"
          {{- end }}

        # Inject dynamic DB credentials
        vault.hashicorp.com/agent-inject-secret-db-dynamic.env: "database/creds/payment-db-role"
        vault.hashicorp.com/agent-inject-template-db-dynamic.env: |
          {{ with secret "database/creds/payment-db-role" -}}
          export DB_DYNAMIC_USER="{{ .Data.username }}"
          export DB_DYNAMIC_PASS="{{ .Data.password }}"
          {{- end }}

        # Agent resource limits
        vault.hashicorp.com/agent-requests-cpu: "50m"
        vault.hashicorp.com/agent-requests-mem: "64Mi"
        vault.hashicorp.com/agent-limits-cpu: "100m"
        vault.hashicorp.com/agent-limits-mem: "128Mi"

        # Pre-populate before app starts (wait for secrets)
        vault.hashicorp.com/agent-pre-populate-only: "false"
        vault.hashicorp.com/secret-volume-path: "/vault/secrets"

        # Refresh interval for dynamic secrets
        vault.hashicorp.com/agent-inject-command-db-dynamic.env: "sh -c 'kill -SIGHUP $(pgrep -f myapp)'"

    spec:
      serviceAccountName: payment-service
      containers:
        - name: payment-service
          image: ghcr.io/myorg/payment-service@sha256:DIGEST
          command: ["/bin/sh", "-c"]
          args:
            - |
              source /vault/secrets/db.env
              source /vault/secrets/db-dynamic.env
              exec /app/payment-service
          resources:
            requests: {memory: "128Mi", cpu: "100m"}
            limits: {memory: "512Mi", cpu: "500m"}
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
