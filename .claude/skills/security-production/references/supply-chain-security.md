# Supply Chain Security

## SLSA Framework (Supply-chain Levels for Software Artifacts)

```
SLSA Level 1: Documented build process (basic provenance)
SLSA Level 2: Build service + signed provenance
SLSA Level 3: Hardened build platform + non-falsifiable provenance  ← Production target
SLSA Level 4: Two-party review + hermetic builds (rare, high-security)
```

### SLSA L3 Requirements

| Requirement | Control |
|-------------|---------|
| Source: Version controlled | Git with signed commits |
| Source: Verified history | Require signed tags/commits (GPG/SSH) |
| Build: Scripted build | Makefile/CI pipeline only |
| Build: Build service | GitHub Actions / Cloud Build (not local) |
| Build: Ephemeral environment | Fresh runner per build (no reuse) |
| Provenance: Available | SLSA provenance attestation generated |
| Provenance: Authenticated | Signed with OIDC (Sigstore/Fulcio) |
| Provenance: Non-falsifiable | Provenance generated by build platform |

---

## Sigstore Ecosystem

```
┌─────────────────────────────────────────────────────────┐
│                    Sigstore                             │
│                                                         │
│  Cosign      → Signs container images + attestations   │
│  Fulcio      → Issues short-lived OIDC-based certs     │
│  Rekor       → Immutable transparency log (audit)      │
│  Policy Ctrl → Admission-time signature verification   │
└─────────────────────────────────────────────────────────┘
```

---

## Cosign: Keyless Image Signing

### Sign in GitHub Actions (OIDC — no long-lived keys)

```yaml
# .github/workflows/build-sign.yaml
name: Build, Sign, and Attest

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write          # Required for OIDC
  packages: write          # Push to ghcr.io

jobs:
  build-sign-attest:
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ github.repository }}:${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ env.IMAGE }}
          sbom: true                   # BuildKit SBOM
          provenance: mode=max         # BuildKit provenance

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image with Cosign (keyless OIDC)
        run: |
          cosign sign --yes \
            ${{ env.IMAGE }}@${{ steps.build.outputs.digest }}

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Attest SBOM
        run: |
          cosign attest --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            ${{ env.IMAGE }}@${{ steps.build.outputs.digest }}

      - name: Generate SLSA Provenance
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
        with:
          image: ${{ env.IMAGE }}
          digest: ${{ steps.build.outputs.digest }}
          registry-username: ${{ github.actor }}
        secrets:
          registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan SBOM for vulnerabilities
        uses: anchore/scan-action@v4
        with:
          sbom: sbom.spdx.json
          fail-build: true
          severity-cutoff: high
```

### Verify Image Signature

```bash
# Verify Cosign signature (keyless)
cosign verify \
  --certificate-identity-regexp="https://github.com/myorg/myrepo/.github/workflows/.*@refs/heads/main" \
  --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
  ghcr.io/myorg/myapp@sha256:abc123...

# Verify SLSA provenance
cosign verify-attestation \
  --type slsaprovenance \
  --certificate-identity-regexp="https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v2.0.0" \
  --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
  ghcr.io/myorg/myapp@sha256:abc123...

# Verify SBOM attestation
cosign verify-attestation \
  --type spdxjson \
  --certificate-identity-regexp="https://github.com/myorg/myrepo/.github/workflows/.*" \
  --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
  ghcr.io/myorg/myapp@sha256:abc123... | jq -r '.payload | @base64d | fromjson'
```

---

## Kyverno: Enforce Signature at Admission

```yaml
# Require signed images from trusted registries
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-image-signature
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-image-signature
      match:
        any:
          - resources:
              kinds: [Pod]
              namespaces: ["production", "staging"]
      verifyImages:
        - imageReferences:
            - "ghcr.io/myorg/*"
          attestors:
            - count: 1
              entries:
                - keyless:
                    subject: "https://github.com/myorg/myrepo/.github/workflows/build-sign.yaml@refs/heads/main"
                    issuer: "https://token.actions.githubusercontent.com"
                    rekor:
                      url: https://rekor.sigstore.dev
          attestations:
            - predicateType: https://spdx.dev/Document          # SBOM required
              conditions:
                - all:
                    - key: "{{ spdxVersion }}"
                      operator: Equals
                      value: "SPDX-2.3"
```

---

## Dependency Security

### Python — pip-audit

```bash
# Scan installed packages for known CVEs
pip-audit --requirement requirements.txt \
  --output json \
  --format json > audit-results.json

# Fix: upgrade vulnerable packages
pip-audit --fix requirements.txt
```

### Node.js — npm audit

```bash
# Audit with fail on high severity
npm audit --audit-level=high --json > npm-audit.json

# Fix automatically (non-breaking)
npm audit fix
```

### Go — govulncheck

```bash
# Go vulnerability check (stdlib + dependencies)
govulncheck ./...

# Check specific package
govulncheck golang.org/x/text
```

### Java — OWASP Dependency Check

```xml
<!-- Maven pom.xml -->
<plugin>
  <groupId>org.owasp</groupId>
  <artifactId>dependency-check-maven</artifactId>
  <version>10.0.3</version>
  <configuration>
    <failBuildOnCVSS>7</failBuildOnCVSS>   <!-- Fail on HIGH (CVSS ≥ 7) -->
    <formats>JSON,HTML</formats>
    <nvdApiKey>${env.NVD_API_KEY}</nvdApiKey>
  </configuration>
</plugin>
```

---

## Git Commit Signing

```bash
# Configure Git to sign all commits with SSH key
git config --global commit.gpgsign true
git config --global gpg.format ssh
git config --global user.signingkey ~/.ssh/id_ed25519.pub

# Or with GPG key
git config --global commit.gpgsign true
git config --global user.signingkey GPGKEYID

# Require signed commits in GitHub branch protection
# Settings → Branches → Require signed commits
```

---

## Supply Chain Controls Comparison

| Control | What It Protects | Tool | SLSA Level |
|---------|-----------------|------|------------|
| Signed commits | Source integrity | GPG/SSH + branch protection | L1 |
| Pinned base images | Build reproducibility | Digest pinning + Renovate | L2 |
| Hermetic build | No external fetches during build | BuildKit --network=none | L3 |
| Signed image | Artifact authenticity | Cosign keyless | L2-L3 |
| SBOM | Dependency inventory | Syft/Grype | L2+ |
| SLSA provenance | Build process verification | slsa-github-generator | L3 |
| Dependency auditing | Known CVEs in deps | pip-audit/npm audit/govulncheck | L1 |
| Image signature verification | Admission control | Kyverno verifyImages | L2-L3 |
| Rekor transparency | Non-repudiation | Sigstore Rekor | L3 |
